<!doctype html>
<html>
  <head>
    <title>THREE Instanced Particles demo</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }

      .canvas, .stats, .gui {
        top: 0;
        position: absolute;
      }

      .stats, .gui {
        z-index: 2;
      }

      .stats {
        left: 0;
      }

      .gui {
        right: 0;
      }
    </style>
  </head>
  <body>
    <script src="node_modules/cannon/build/cannon.js"></script>
    <script src="node_modules/three/build/three.js"></script>
    <script src="node_modules/three/examples/js/controls/OrbitControls.js"></script>
    <script src="dist/index.umd.js"></script>
    <script>
      /* RENDERING */

      const renderer = new THREE.WebGLRenderer({
        antialias: false
      })

      const camera = new THREE.PerspectiveCamera(45, 1, 1, 1000)
      camera.position.set(3, 2, 3)

      /* SCENE */

      const scene = new THREE.Scene()

      const ambientLight = new THREE.AmbientLight()
      const pointLight = new THREE.PointLight()
      pointLight.position.set(6, 4, 6)

      const axes = new THREE.AxesHelper()
      const grid = new THREE.GridHelper()

      const world = new CANNON.World()
      world.gravity.set(0, -9.82, 0)
      world.broadphase = new CANNON.NaiveBroadphase()
      world.solver.iterations = 1

      const ground = new CANNON.Body({
        mass: 0,
        shape: new CANNON.Plane()
      })

      ground.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2)

      world.addBody(ground)

      const particleSource = new THREEInstancedParticles.PhysicalParticleSource({
        world,
        count: 500,
        geometry: new THREE.TorusBufferGeometry(),
        material: new THREE.MeshStandardMaterial()
      })

      particleSource.generate()

      scene.add(
        ambientLight,
        pointLight,
        axes,
        grid,
        particleSource
      )

      /* INTERFACE */

      const controls = new THREE.OrbitControls(camera, renderer.domElement)
      controls.enableDamping = true
      controls.dampingFactor = 0.1
      controls.zoomSpeed = 0.5

      /* UPDATE */

      const fixedDelta = 1 / 60
      let trigger = 0

      const dummyEuler = new THREE.Euler()

      function update(delta, time) {
        controls.update()

        world.step(fixedDelta, delta, 1)

        particleSource.update()

        if (trigger >= 50) {
          trigger = 0

          if (particleSource.appendedParticles >= particleSource.count) {
            particleSource.removeParticles()
          } else {
            particleSource.appendParticle({
              prepare: particle => {
                particle.position.set(
                  Math.random() * 2 - 1, 0, Math.random() * 2 - 1
                )

                particle.quaternion.setFromEuler(dummyEuler.set(
                  Math.random() * Math.PI,
                  Math.random() * Math.PI,
                  Math.random() * Math.PI
                ))
              }
            })
          }
        } else {
          trigger += delta
        }
      }

      /* RESIZE */

      function resize() {
        const { innerWidth: width, innerHeight: height } = window
        renderer.setSize(width, height)
        camera.aspect = width / height
        camera.updateProjectionMatrix()
      }

      /* LOOP */

      const now = (
        typeof performance === 'undefined' ||
        typeof navigator === 'undefined' ||
        !navigator.userAgent.toLowerCase().includes('firefox')
      ) ? Date.now.bind(Date) : performance.now.bind(performance)

      let date, initialDate

      function loop() {
        const delta = now() - date
        date += delta

        update(delta, date - initialDate)
        renderer.render(scene, camera)
        requestAnimationFrame(loop)
      }

      /* DOM */

      addEventListener('resize', resize)

      renderer.domElement.classList.add('canvas')

      document.body.appendChild(renderer.domElement)

      /* START */

      date = initialDate = now()

      resize()
      loop()
    </script>
  </body>
</html>

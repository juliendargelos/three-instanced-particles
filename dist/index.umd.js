!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three"),require("three/examples/jsm/utils/BufferGeometryUtils")):"function"==typeof define&&define.amd?define(["exports","three","three/examples/jsm/utils/BufferGeometryUtils"],t):t((e=e||self).ThreeInstancedParticles={},e.THREE,e.THREE.BufferGeometryUtils)}(this,function(e,t,i){"use strict";var r=function(){function e(){this.position=new t.Vector3,this.quaternion=new t.Quaternion,this.scale=new t.Vector3}return e.compose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t,i){var r=e.length,o=e.map(function(e){return e(t,function(){--r||i()})});return{pause:function(){return o.forEach(function(e){e&&e.pause()})}}}},e.prototype.start=function(e,t){var i=this;this.stop(),this.animation=e(this,function(){t(),i.animation=void 0})},e.prototype.stop=function(){this.animation&&!this.animation.pause&&console.log(this.animation),this.animation&&this.animation.pause()},e.prototype.dispose=function(){this.animation&&this.animation.pause(),this.animation=void 0},e.show=function(e,t){e.scale.set(1,1,1),t()},e.hide=function(e,t){e.scale.set(0,0,0),t()},e}(),o=function(){function e(){this.position=new t.Vector3,this.quaternion=new t.Quaternion,this.scale=new t.Vector3(1,1,1),this.matrix=new t.Matrix4,this.transition=new r,this.appended=!1}return e.prototype.append=function(e,t){this.appended=!0,this.transition.start(e||r.show,function(){t&&t()})},e.prototype.remove=function(e,t){var i=this;this.transition.start(e||r.hide,function(){i.appended=!1,t&&t()})},e.prototype.update=function(){return!!this.appended&&(this.matrix.compose(this.position.clone().add(this.transition.position),this.quaternion.clone().multiply(this.transition.quaternion),this.scale.clone().multiply(this.transition.scale)),!0)},e.prototype.dispose=function(){this.transition.dispose()},e}(),n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function a(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&(i[r[o]]=e[r[o]])}return i}var s,c=function(e,t,i){var r=i.get;i.get=function(){return Object.defineProperty(e,t,{value:r.call(e)})[t]}};!function(e){e[e.Append=1]="Append",e[e.Remove=-1]="Remove"}(s||(s={}));var p=function(e){function r(t){var i=void 0===t?{}:t,r=i.geometry,o=void 0===r?void 0:r,n=i.material,a=void 0===n?void 0:n,s=i.count,c=void 0===s?0:s,p=i.color,l=void 0===p?16777215:p,h=i.transition,u=void 0===h?{}:h,f=e.call(this)||this;return f.particles=[],f._usesNormalMaterial=!1,f.appendedParticles=0,f.transition=u,f.geometry=o,f.material=a,f.color=l,f.count=c,f}return function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}(r,e),Object.defineProperty(r.prototype,"normalMaterial",{get:function(){return new t.MeshNormalMaterial({morphTargets:!0,skinning:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"generated",{get:function(){return!!this.mesh},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"geometry",{get:function(){return this._geometry},set:function(e){this._geometry=e,this.mesh&&e&&(this.mesh.geometry=e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"material",{get:function(){return this._material},set:function(e){var t=this;this._material=e,this.mesh&&e&&(Array.isArray(e)?e.forEach(function(e){return e.color.set(t.color)}):e.color.set(this.color),this.usesNormalMaterial||(this.mesh.material=e))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"color",{get:function(){return this._color},set:function(e){this._color=e,this.material&&(Array.isArray(this.material)?this.material.forEach(function(t){return t.color.set(e)}):this.material.color.set(e))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"usesNormalMaterial",{get:function(){return this._usesNormalMaterial},set:function(e){this._usesNormalMaterial=e,this.mesh&&(e||this.material)&&(this.mesh.material=e?this.normalMaterial:this.material)},enumerable:!0,configurable:!0}),r.prototype.createParticle=function(){return new o},r.prototype.prepareParticle=function(e,t){if(!this.mesh)throw new Error("The mesh and particles have not been generated, call generate() before calling appendParticle() or removeParticle()");var i;switch(e){case s.Append:if(this.appendedParticles>=this.mesh.count)throw new Error("All "+this.mesh.count+" particles have already been appended, increase count and call generate() to append more particles.");i=this.particles[this.appendedParticles++];break;case s.Remove:if(this.appendedParticles<=0)throw new Error("All "+this.mesh.count+" particles have already been removed, you cannot remove more particles.");i=this.particles[--this.appendedParticles]}return t&&t(i),i},r.prototype.useGLTF=function(e){var t=function(e){var t=[],r=[];if(e.scene.traverse(function(e){e.isMesh&&(e.updateMatrixWorld(!0),e.geometry.applyMatrix(e.matrixWorld),t.push(e.geometry),r.push(e.material))}),!t.length)throw new Error("Could not find any geometry in GLTF scene");return{geometry:1===t.length?t[0]:i.BufferGeometryUtils.mergeBufferGeometries(t,!0),material:1===r.length?r[0]:r}}(e),r=t.geometry,o=t.material;this.geometry=r,this.material=o},r.prototype.generate=function(){if(!this.geometry||!this.material)throw new Error("geometry and material must be set before calling generate()");var e=this.particles,i=this.count;for(this.dispose(),this.mesh=new t.InstancedMesh(this.geometry,this.material,i),this.mesh.frustumCulled=!1,this.appendedParticles=Math.min(this.appendedParticles,i);e.length<i;)e.push(this.createParticle());e.splice(i).forEach(function(e){return e.dispose()}),this.add(this.mesh)},r.prototype.dispose=function(e){void 0===e&&(e=!1),this.mesh&&(this.remove(this.mesh),this.mesh=void 0),e&&this.particles.splice(0).forEach(function(e){return e.dispose()})},r.prototype.update=function(){if(this.mesh){var e=this.mesh;this.particles.forEach(function(t,i){t.update()&&(e.setMatrixAt(i,t.matrix),e.instanceMatrix.needsUpdate=!0)})}},r.prototype.appendParticle=function(e){var t=void 0===e?{}:e,i=t.prepare,r=void 0===i?void 0:i,o=t.complete,n=void 0===o?void 0:o,a=t.transition,c=void 0===a?this.transition.append:a;this.prepareParticle(s.Append,r).append(c,n)},r.prototype.removeParticle=function(e){var t=void 0===e?{}:e,i=t.prepare,r=void 0===i?void 0:i,o=t.complete,n=void 0===o?void 0:o,a=t.transition,c=void 0===a?this.transition.remove:a;this.prepareParticle(s.Remove,r).append(c,n)},r.prototype.appendParticles=function(e){void 0===e&&(e={});var t=e.amount,i=void 0===t?1/0:t,r=a(e,["amount"]);i=Math.min(i,this.count-this.appendedParticles);for(var o=0;o<i;o++)this.appendParticle(r)},r.prototype.removeParticles=function(e){void 0===e&&(e={});var t=e.amount,i=void 0===t?1/0:t,r=a(e,["amount"]);i=Math.min(i,this.appendedParticles);for(var o=0;o<i;o++)this.removeParticle(r)},function(e,t,i,r){var o,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(a=(n<3?o(a):n>3?o(t,i,a):o(t,i))||a);n>3&&a&&Object.defineProperty(t,i,a)}([c],r.prototype,"normalMaterial",null),r}(t.Object3D);e.Particle=o,e.ParticleSource=p,e.Transition=r,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.js.map

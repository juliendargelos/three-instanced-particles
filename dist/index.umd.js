!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three"),require("three/examples/jsm/loaders/GLTFLoader"),require("three/examples/jsm/utils/BufferGeometryUtils"),require("cannon")):"function"==typeof define&&define.amd?define(["exports","three","three/examples/jsm/loaders/GLTFLoader","three/examples/jsm/utils/BufferGeometryUtils","cannon"],t):t((e=e||self).THREEInstancedParticles={},e.THREE,e.THREE.GLTFLoader,e.THREE.BufferGeometryUtils,e.CANNON)}(this,function(e,t,i,o,r){"use strict";var n,a=function(){function e(){this.position=new t.Vector3,this.quaternion=new t.Quaternion,this.scale=new t.Vector3}return e.compose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t,i){var o=e.length,r=e.map(function(e){return e(t,function(){--o||i()})});return{pause:function(){return r.forEach(function(e){e&&e.pause()})}}}},e.prototype.start=function(e,t){var i=this;this.stop(),this.animation=e(this,function(){t(),i.animation=void 0})},e.prototype.stop=function(){this.animation&&!this.animation.pause&&console.log(this.animation),this.animation&&this.animation.pause()},e.prototype.dispose=function(){this.animation&&this.animation.pause(),this.animation=void 0},e.show=function(e,t){e.scale.set(1,1,1),t()},e.hide=function(e,t){e.scale.set(0,0,0),t()},e}(),s=function(){function e(){this.position=new t.Vector3,this.quaternion=new t.Quaternion,this.scale=new t.Vector3(1,1,1),this.matrix=new t.Matrix4,this.transition=new a,this.appended=!1,this.removed=!1}return e.prototype.append=function(e,t){var i=this;this.appended=!0,this.transition.start(e||a.show,function(){t&&t(i)})},e.prototype.remove=function(e,t){var i=this;this.transition.start(e||a.hide,function(){i.removed=!0,t&&t(i)})},e.prototype.update=function(){return!!this.appended&&(this.matrix.compose(this.position.clone().add(this.transition.position),this.quaternion.clone().multiply(this.transition.quaternion),this.scale.clone().multiply(this.transition.scale)),this.removed&&(this.appended=!1,this.removed=!1),!0)},e.prototype.dispose=function(){this.transition.dispose()},e}(),p=function(e,t){return(p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function h(e,t){function i(){this.constructor=e}p(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function c(e,t){var i={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(i[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&(i[o[r]]=e[o[r]])}return i}function l(e,t,i){var o=i.get;i.get=function(){return Object.defineProperty(e,t,{value:o.call(e)})[t]}}!function(e){e[e.Append=1]="Append",e[e.Remove=-1]="Remove"}(n||(n={}));var u=function(e){function r(t){var i=void 0===t?{}:t,o=i.geometry,r=void 0===o?void 0:o,n=i.material,a=void 0===n?void 0:n,s=i.count,p=void 0===s?0:s,h=i.color,c=void 0===h?16777215:h,l=i.transition,u=void 0===l?{}:l,d=e.call(this)||this;return d._usesNormalMaterial=!1,d.particles=[],d.appendedParticles=0,d.transition=u,d.geometry=r,d.material=a,d.color=c,d.count=p,d}return h(r,e),Object.defineProperty(r.prototype,"normalMaterial",{get:function(){return new t.MeshNormalMaterial({morphTargets:!0,skinning:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"generated",{get:function(){return!!this.mesh},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"geometry",{get:function(){return this._geometry},set:function(e){this._geometry=e,this.updateGeometry()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"material",{get:function(){return this._material},set:function(e){this._material=e,this.updateMaterial()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"color",{get:function(){return this._color},set:function(e){this._color=e,this.material&&(Array.isArray(this.material)?this.material.forEach(function(t){return t.color.set(e)}):this.material.color.set(e))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"usesNormalMaterial",{get:function(){return this._usesNormalMaterial},set:function(e){this._usesNormalMaterial=e,this.mesh&&(e||this.material)&&(this.mesh.material=e?this.normalMaterial:this.material)},enumerable:!0,configurable:!0}),r.prototype.updateGeometry=function(){this.mesh&&this.geometry&&(this.mesh.geometry=this.geometry)},r.prototype.updateMaterial=function(){var e=this;this.mesh&&this.material&&(Array.isArray(this.material)?this.material.forEach(function(t){return t.color.set(e.color)}):this.material.color.set(this.color),this.usesNormalMaterial||(this.mesh.material=this.material))},r.prototype.createParticle=function(){return new s},r.prototype.prepareParticle=function(e,t){if(!this.mesh)throw new Error("The mesh and particles have not been generated, call generate() before calling appendParticle() or removeParticle()");var i;switch(e){case n.Append:if(this.appendedParticles>=this.mesh.count)throw new Error("All "+this.mesh.count+" particles have already been appended, increase count and call generate() to append more particles.");i=this.particles[this.appendedParticles++];break;case n.Remove:if(this.appendedParticles<=0)throw new Error("All "+this.mesh.count+" particles have already been removed, you cannot remove more particles.");i=this.particles[--this.appendedParticles]}return t&&t(i),i},r.prototype.useGLTF=function(e){var t=function(e){var t=[],i=[];if(e.scene.traverse(function(e){e.isMesh&&(e.updateMatrixWorld(!0),e.geometry.applyMatrix(e.matrixWorld),t.push(e.geometry),i.push(e.material))}),!t.length)throw new Error("Could not find any geometry in GLTF scene");return{geometry:1===t.length?t[0]:o.BufferGeometryUtils.mergeBufferGeometries(t,!0),material:1===i.length?i[0]:i}}(e),i=t.geometry,r=t.material;this.geometry=i,this.material=r},r.prototype.loadGLTF=function(e,t){var o=this;(new i.GLTFLoader).load(e,function(e){o.useGLTF(e),t&&t(e)})},r.prototype.generate=function(){if(!this.geometry||!this.material)throw new Error("geometry and material must be set before calling generate()");var e=this.particles,i=this.count;for(this.disposeMesh(),this.mesh=new t.InstancedMesh(this.geometry,this.material,i),this.mesh.frustumCulled=!1,this.appendedParticles=Math.min(this.appendedParticles,i);e.length<i;)e.push(this.createParticle());this.disposeParticles(i),this.add(this.mesh)},r.prototype.disposeMesh=function(){this.mesh&&(this.remove(this.mesh),this.mesh=void 0)},r.prototype.disposeParticles=function(e){void 0===e&&(e=0),this.particles.splice(e).forEach(function(e){return e.dispose()})},r.prototype.disposeGeometry=function(){this.geometry&&(this.geometry.dispose(),this.geometry=void 0)},r.prototype.disposeMaterial=function(){this.material&&(Array.isArray(this.material)?this.material.forEach(function(e){return e.dispose()}):this.material.dispose(),this.material=void 0)},r.prototype.update=function(){if(this.mesh){var e=this.mesh;this.particles.forEach(function(t,i){t.update()&&(e.setMatrixAt(i,t.matrix),e.instanceMatrix.needsUpdate=!0)})}},r.prototype.appendParticle=function(e){var t=void 0===e?{}:e,i=t.prepare,o=void 0===i?void 0:i,r=t.complete,a=void 0===r?void 0:r,s=t.transition,p=void 0===s?this.transition.append:s;this.prepareParticle(n.Append,o).append(p,a)},r.prototype.removeParticle=function(e){var t=void 0===e?{}:e,i=t.prepare,o=void 0===i?void 0:i,r=t.complete,a=void 0===r?void 0:r,s=t.transition,p=void 0===s?this.transition.remove:s;this.prepareParticle(n.Remove,o).remove(p,a)},r.prototype.appendParticles=function(e){void 0===e&&(e={});var t=e.amount,i=void 0===t?1/0:t,o=c(e,["amount"]);i=Math.min(i,this.count-this.appendedParticles);for(var r=0;r<i;r++)this.appendParticle(o)},r.prototype.removeParticles=function(e){void 0===e&&(e={});var t=e.amount,i=void 0===t?1/0:t,o=c(e,["amount"]);i=Math.min(i,this.appendedParticles);for(var r=0;r<i;r++)this.removeParticle(o)},function(e,t,i,o){var r,n=arguments.length,a=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,o);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(a=(n<3?r(a):n>3?r(t,i,a):r(t,i))||a);n>3&&a&&Object.defineProperty(t,i,a)}([l],r.prototype,"normalMaterial",null),r}(t.Object3D),d=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);return-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0),this},t.prototype.clearShapes=function(e){return void 0===e&&(e=!0),this.shapes.length&&(this.shapes.splice(0),this.shapeOffsets.splice(0),this.shapeOrientations.splice(0),e&&(this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0)),this},t}(r.Body),f=function(e){function t(){var t=e.call(this)||this;return t.freezeDelay=1/0,t.freezeFactor=new r.Vec3(.9,1,.9),t.freezeThreshold=.001,t.freezing=!1,t.frozen=!1,t.body=new d(t.bodyParameters),t}return h(t,e),Object.defineProperty(t.prototype,"bodyParameters",{get:function(){return{mass:1,type:d.DYNAMIC}},enumerable:!0,configurable:!0}),t.prototype.freeze=function(){var e=this.body.velocity;if(e.almostZero(this.freezeThreshold))return this.frozen=!0,this.freezing=!1,void(this.body.type=d.STATIC);var t=this.freezeFactor;e.x*=t.x,e.y*=t.y,e.z*=t.z},t.prototype.requestFreeze=function(){var e=this;this.freezeDelay!==1/0&&(this.cancelFreeze(),this.freezeTimeout=window.setTimeout(function(){e.freezing=!0},this.freezeDelay))},t.prototype.cancelFreeze=function(){void 0!==this.freezeTimeout&&(clearTimeout(this.freezeTimeout),this.freezeTimeout=void 0)},t.prototype.append=function(t,i){var o=this;this.freezing=this.frozen=!1,this.body.type=d.DYNAMIC,e.prototype.append.call(this,t,function(e){o.requestFreeze(),i&&i(e)})},t.prototype.remove=function(t,i){this.cancelFreeze(),e.prototype.remove.call(this,t,i)},t.prototype.update=function(){return!!this.appended&&(this.freezing&&this.freeze(),this.frozen||this.synchronizeBody(),e.prototype.update.call(this))},t.prototype.clearBodyShape=function(){this.body.clearShapes()},t.prototype.setBodyShape=function(e){this.body.clearShapes(!1),this.body.addShape(e)},t.prototype.synchronizeBody=function(){this.position.copy(this.body.position),this.quaternion.copy(this.body.quaternion)},t.prototype.resetBodyPosition=function(){var e=this.position,t=e.x,i=e.y,o=e.z;this.body.position.set(t,i,o)},t.prototype.resetBodyQuaternion=function(){var e=this.quaternion,t=e.x,i=e.y,o=e.z,r=e.w;this.body.quaternion.set(t,i,o,r)},t.prototype.resetBodyVelocity=function(){this.body.velocity.set(0,0,0)},t.prototype.resetBodyAngularVelocity=function(){this.body.angularVelocity.set(0,0,0)},t}(s),m=function(e){function t(t){var i=t.world,o=c(t,["world"]),r=e.call(this,o)||this;return r.world=i,r}return h(t,e),t.prototype.updateGeometry=function(){if(this.geometry){var e=this.shape=this.createShape();this.particles.forEach(function(t){return t.setBodyShape(e)})}else this.particles.forEach(function(e){return e.clearBodyShape()})},t.prototype.createShape=function(){this.geometry.boundingBox||this.geometry.computeBoundingBox();var e=this.geometry.boundingBox;return new r.Box(new r.Vec3((e.max.x-e.min.x)/2,(e.max.y-e.min.y)/2,(e.max.z-e.min.z)/2))},t.prototype.createParticle=function(){var e=new f;return this.shape&&e.setBodyShape(this.shape),e},t.prototype.appendParticle=function(t){var i=this,o=void 0===t?{}:t,r=o.prepare,n=void 0===r?void 0:r,a=o.complete,s=void 0===a?void 0:a,p=o.transition,h=void 0===p?this.transition.append:p;e.prototype.appendParticle.call(this,{complete:s,transition:h,prepare:function(e){e.resetBodyVelocity(),e.resetBodyAngularVelocity(),n&&n(e),e.resetBodyPosition(),e.resetBodyQuaternion(),i.world.addBody(e.body)}})},t.prototype.removeParticle=function(t){var i=this,o=void 0===t?{}:t,r=o.prepare,n=void 0===r?void 0:r,a=o.complete,s=void 0===a?void 0:a,p=o.transition,h=void 0===p?this.transition.append:p;e.prototype.removeParticle.call(this,{prepare:n,transition:h,complete:function(e){i.world.remove(e.body),s&&s(e)}})},t}(u);e.Particle=s,e.ParticleSource=u,e.PhysicalParticle=f,e.PhysicalParticleSource=m,e.Transition=a,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.js.map
